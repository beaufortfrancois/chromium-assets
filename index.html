<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Chromium Assets</title>
    <link href="//fonts.googleapis.com/css?family=Monda" rel="stylesheet" type="text/css">
    <style>

body {
    margin: 0 auto;
    font-family: 'Monda', sans-serif;
    transition: background-color .1s;
    background: #ddd url(static/bg.png);
}

.darkroom {
    background: #333;
}

.header {
    text-align: center;
    margin-bottom: 30px;
    color: #888;
    line-height: 3em;
    background-color: rgba(255 ,255, 255, .8);
    margin-left: auto;
    margin-right: auto;
}
.darkroom .header {
    background-color: #222;
}
.darkroom .name,
.darkroom .size {
    background-color: rgba(255, 255, 255, .1);
}
.title {
    color: #555;
    padding-right: 10px;
    font-weight: bold;
    cursor: pointer;
}
input[type=search] {
    border-radius: 2px;
    color: #555;
    padding-left: 8px;
    outline: none;
    height: 2.1em;
    border: 1px solid #ccc;
    font-size: 16px;
    box-shadow: inset 0px -1px 0px #eee;
}
.darkroom input[type=search] {
    border: 1px solid #666;
    background-color: #333;
    box-shadow: inset 0px -1px 0px #999;
    color: #ccc;
}
input[type=checkbox] {
    vertical-align: middle;
    margin-left: 8px;
}
label {
    font-size: 80%;
}
.assets {
    max-width: 1120px;
    margin: 0 auto;
}
.asset {
    width: 128px;
    height: 148px;
    float: left;
    padding: 8px;
    margin: 8px;
    display: -webkit-box;
    -webkit-box-pack: center;
    -webkit-box-align: center;
    -webkit-box-orient: vertical;
    overflow: overlay;
}

.asset::-webkit-scrollbar {
    width: 4px;
    height: 4px;
}

.asset::-webkit-scrollbar-thumb {
    background-color: #999;
}

.darkroom .asset {
    background: transparent;
    box-shadow: none;
}

.asset img {
    max-width: 118px;
    max-height: 118px;
}
.asset img:hover {
    max-height: none;
    max-width: none;
}
.size, .name {
    font-size: 70%;
    margin-top: 6px;
    color: #999;
    background: whitesmoke;
    border-radius: 3px;
    padding: 0 3px;
    box-shadow: 0 1px 2px;
    white-space:nowrap
}
audio {
    width: 88px;
}
audio::-webkit-media-controls-timeline,
audio::-webkit-media-controls-volume-slider,
audio::-webkit-media-controls-mute-button {
    display: none;
}

.footer {
    clear: left;
    height: 30px;
}
.loading {
    width: 22px;
    height: 22px;
    position: fixed;
    right: 14px;
    bottom: 14px;
}
.hidden {
    display: none;
}
    </style>
  </head>
<body>

<div class="header">
    <span class="title">Chromium Assets</span>
    <datalist id="searchExamples">
        <option value="profile">
        <option value="cros">
        <option value="avatar">
        <option value="bluetooth">
    </datalist>
    <input type="search" placeholder="search..." list="searchExamples">
    <input name="displayHiDPI" id="displayHiDPI" type="checkbox" checked>
    <label for="displayHiDPI">HiDPI</label>
    <input name="toggleBackground" id="toggleBackground" type="checkbox">
    <label for="toggleBackground">Darkroom</label>
</div>
<div class="assets"></div>

<div class="footer"></div>

<script>
    var assets = {};
    var notFoundUrls = [];
    var numberAssets, results;

    var searchInput = document.querySelector('input');
    var assetsDiv = document.querySelector('.assets');
    var loadingImage = document.querySelector('.loading');
    var displayHiDPICheckbox = document.querySelector('#displayHiDPI');

    function removeImageEventListeners(image) {
        image.removeEventListener('load', onImageLoaded);
        image.removeEventListener('error', onImageError);
    }

    function removeAudioEventListeners(audio) {
        audio.removeEventListener('canplay', onAudioLoaded);
    }

    function onAudioLoaded() {
        removeImageEventListeners(this);
        this.parentNode.parentNode.style.visibility = '';

        numberAssets++;
        updateLoadingImage();
    }

    function appendAudio(url, title) {
        var asset = document.createElement('div');
        asset.classList.add('asset');
        asset.title = title;
        asset.style.visibility = 'hidden';

        var anchor = document.createElement('a');
        anchor.href = url;
        anchor.target = "_blank";
        anchor.rel = "nofollow";

        var audio = document.createElement('audio');
        audio.title = title;
        audio.controls = true;
        audio.addEventListener('canplay', onAudioLoaded);
        audio.src = url;

        anchor.appendChild(audio);
        asset.appendChild(anchor);

        var name = document.createElement('div');
        var friendlyName = url.substr(url.lastIndexOf('/')+1, url.length);
        friendlyName = friendlyName.substr(0, friendlyName.length - '.wav'.length);
        friendlyName = friendlyName.replace(/(-|_)/g, ' ');
        name.innerText = friendlyName;
        name.classList.add('name');
        asset.appendChild(name);

        assetsDiv.appendChild(asset);
    }

    function onImageError() {
        notFoundUrls.push(this.src);

        if ((this.src.indexOf('default_100_percent') === -1)  &&
            (this.src.indexOf('default_200_percent') !== -1)) {
            // fallback to lower resolution
            var newUrl = this.src.replace('default_200_percent', 'default_100_percent');
            for (var i = 0; i < assets.length; i++) {
                var url = assets[i][0].replace(/\\/g, '/');
                if (url === this.src)
                    assets[i][0] = newUrl;
            }
            this.src = newUrl;
            this.parentNode.href = newUrl;
        } else {
            updateLoadingImage();

            removeImageEventListeners(this);
        }
    }

    function onImageLoaded(event) {
        var size = document.querySelector('[title="'+ this.title +'"] [href="'+ this.src +'"]~.size');
        size.innerText = this.width +'x'+ this.height;

        removeImageEventListeners(this);
        this.parentNode.parentNode.style.visibility = '';

        numberAssets++;
        updateLoadingImage();
    }

    function appendImage(url, title) {
        var asset = document.createElement('div');
        asset.classList.add('asset');
        asset.title = title;
        asset.style.visibility = 'hidden';

        var anchor = document.createElement('a');
        anchor.href = url;
        anchor.target = "_blank";
        anchor.rel = "nofollow";

        var image = new Image();
        image.title = title;
        image.addEventListener('load', onImageLoaded);
        image.addEventListener('error', onImageError);
        image.src = url;

        anchor.appendChild(image);
        asset.appendChild(anchor);

        var size = document.createElement('div');
        size.classList.add('size');
        size.innerText = '...';
        asset.appendChild(size);

        assetsDiv.appendChild(asset);
    }

    function insertAsset(asset) {
        assetsDiv.appendChild(asset);

        numberAssets++;
    }

    function displayAssets() {
        var filter = searchInput.value;
        var regExp = new RegExp(filter, 'i');

        var displayHiDPI = displayHiDPICheckbox.checked;

        window.location.hash = filter;

        numberAssets = 0;
        results = [];

        assetsDiv.innerText = '';

        var i = 0;
        for (var i = 0; i < assets.length; i++) {
            var title = assets[i][1];
            var url = assets[i][0].replace(/\\/g, '/');
            if (!displayHiDPI)  url = url.replace('default_200_percent', 'default_100_percent');

            if (filter !== searchInput.value) break; 
            if (results.indexOf(url) !== -1) continue;
            if (notFoundUrls.indexOf(url) !== -1) continue;
            if (!filter || regExp.test(url.substr(baseUrl.length))) {
                if (url.indexOf('.wav', url.length - '.wav'.length) !== -1) {
                    appendAudio(url, title);
                } else {
                    appendImage(url, title);
                }
                results.push(url);
            }
        }
    }

    var timeout;

    function triggerSearch() {
        window.stop();
        clearTimeout(timeout);
        timeout = setTimeout(displayAssets, 300);
    }

    onload = function() {
        searchInput.value = decodeURI(window.location.hash.substr(1));

        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/json');
        xhr.onload = function() {
            assets = JSON.parse(xhr.response);
            assets.sort(function(a, b) {
                if (a[1] < b[1]) return -1;
                if (a[1] > b[1]) return 1;
                if (a[0] < b[0]) return -1;
                if (a[0] > b[0]) return 1;
                return 0;
            });
            displayAssets();

            // Search is triggered each time user enters a new character
            searchInput.addEventListener('input', triggerSearch);

            // Search is also triggered when user toggles HiDPI checkbox
            displayHiDPICheckbox.addEventListener('change', triggerSearch);

            // Pressing / focus the search
            document.addEventListener('keyup', function(e) {
                if (e.keyCode === 191 && document.activeElement !== searchInput) {
                    e.preventDefault();
                    searchInput.focus();
                }
            });

            // Toggle Darkroom Mode
            document.querySelector('#toggleBackground').addEventListener('change', function() {
                document.body.classList.toggle('darkroom');
            });
        }
        xhr.send(null);
    }

    var baseUrl = 'https://src.chromium.org/svn/trunk/src/';
</script>
</body>
</html>
